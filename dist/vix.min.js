/*!
 * Vix.js
 * ---------------------------
 * @version 0.1.0 (2016-11-28)
 * @license MIT
 * @author mach3<mach3@mach3.jp>
 */
!function(a){var b=function(c,d){if(this.el=a(c),this.options=a.extend({},this._options,d),this.name=this.el.data("view"),!this.name)throw new Error("No Template");b.__instanceStack__.push(this)};a.extend(b.prototype,{EVENT_RENDERED:"rendered",el:null,name:null,data:null,process:null,options:null,_options:{templatePath:"templates",templateExt:".html",api:window,engine:"lodash"},render:function(b,c){var d=this.el.data();d.rendered&&!b||(a.when(this.fetchTemplate(d),this.fetchAPI(d,c)).done(this.postRender(!!d.rendered,b,c)),this.el.data("rendered",!0))},postRender:function(c,d,e){return function(){var f=a("<div>").append(b.template(this.name)(this.data));f.find("[data-view]").vix(d,e,this.options),c&&d&&this.el.html(""),f.children().appendTo(this.el),this.el.trigger(this.EVENT_RENDERED)}.bind(this)},fetchTemplate:function(c){var d=a.Deferred(),e=this;return this.name in b.__templates__?d.resolve():a.ajax({url:[this.options.templatePath,"/",this.name,this.options.templateExt].join(""),dataType:"text"}).done(function(a){b.template(e.name,b.compile(a,e.options.engine)),d.resolve()}),d.promise()},setData:function(b,c){this.data=a.extend(!0,{},b,c)},fetchAPI:function(b,c){var d,e,f,g=this;return d=a.Deferred(),e=this.dig(b.api),a.isFunction(e)?(f=e.apply(this,[c]),a.isFunction(f.done)?(f.done(function(b){g.setData("string"===a.type(b)?a.parseJSON(b):b,c),d.resolve()}),d.promise()):(this.setData(f,c),d.resolve())):(this.setData(c),d.resolve())},dig:function(a,b){return a=a||"",b=b||this.options.api,a.split(".").forEach(function(a){void 0!==b&&(b=b[a])}),b}}),a.extend(b,{__templates__:{},__instanceKey__:"__VixInstance__",__instanceStack__:[],getInstance:function(a){return this.__instanceStack__=this.__instanceStack__.filter(function(a){return!!a.el.closest("body").length}),void 0===a?this.__instanceStack__:this.__instanceStack__.filter(function(b){return b.name===a})},config:function(b,c){var d=a.type(b);return void 0===b?this.prototype._options:"string"===d?1===arguments.length?this.prototype._options[b]:(this.prototype._options[b]=c,this):("object"===d&&a.extend(!0,this.prototype._options,b),this)},compile:function(b,c){switch(c=c||this.config("engine")){case"lodash":return _.template(b);case"handlebars":return Handlebars.compile(b);case"mustache":return function(a){return Mustache.render(b,a)}}return a.noop},template:function(b,c){var d=a.type(b),e=this;return void 0===b?this.__templates__:"string"===d?1===arguments.length?this.__templates__[b]:(c=a.isFunction(c)?c:this.compile(c),this.__templates__[b]=c,this):"object"===d?(a.each(b,function(a,b){e.template(a,b)}),this):void 0},render:function(){var b=this;return a("script[data-template]").each(function(){var c=a(this);b.template(c.data("template"),c.html())}),a("[data-view]").vix(),this},refresh:function(a,b){return this.getInstance(a).forEach(function(a){a.render(!0,b)}),this},on:function(b,c){return a(document).on(b,"[data-view]",c),this}}),a.fn.vix=function(a,c,d){var e=b.__instanceKey__;return a=!!a,c=void 0===c?{}:c,d=void 0===d?{}:d,this.each(function(){var f=this[e]||new b(this,d);f.render(a,c),this[e]=f}),this},"object"==typeof module&&"object"==typeof module.exports?module.exports=b:window.Vix=b}(jQuery);